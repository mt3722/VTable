<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ·¨åœŸå®—ç«¹å±±å¿µä½›æœƒ - å›å‘åå–®ç®¡ç†ç³»çµ± (V3.0)</title>

<style>
/* =========================================
   1. å­—å‹èˆ‡å…¨åŸŸè¨­å®š
   ========================================= */
@font-face{font-family:'GenRyuMin2';
  src:url('https://raw.githubusercontent.com/mt3722/TableMaker/main/GenRyuMin2TW-B.woff2') format('woff2'),
       url('https://raw.githubusercontent.com/mt3722/TableMaker/main/GenRyuMin2TW-B.woff')  format('woff');}
@font-face{font-family:'BpmfGenRyuMin';
  src:url('https://raw.githubusercontent.com/mt3722/TableMaker/main/BpmfGenRyuMin-B.woff2') format('woff2'),
       url('https://raw.githubusercontent.com/mt3722/TableMaker/main/BpmfGenRyuMin-B.woff')  format('woff');}

@page{size:A4 portrait;margin:0;}
html,body{margin:0;width:100%;height:100%;}
body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f4f6f9; }
*{box-sizing:border-box;}

/* =========================================
   2. ç®¡ç†æ§åˆ¶é¢æ¿
   ========================================= */
.controls-wrapper {
    background: #fff; padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    border-bottom: 4px solid #8b5a2b;
    position: relative; z-index: 10; margin-bottom: 20px;
}
.top-bar {
    max-width: 1300px; margin: 0 auto 20px;
    display: flex; justify-content: space-between; align-items: center;
}
.app-title { font-size: 24px; font-weight: bold; color: #333; display: flex; align-items: center; gap: 10px; }
.btn-print {
    background-color: #6c5ce7; color: white; padding: 8px 20px; 
    border-radius: 5px; font-size: 16px; border: none; cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: 0.2s;
    display: flex; align-items: center; gap: 5px;
}
.btn-print:hover { background-color: #5b4cc4; transform: translateY(-1px); }

.controls-container {
    max-width: 1300px; margin: 0 auto;
    display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
}

.panel {
    background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
    overflow: hidden; display: flex; flex-direction: column; height: 700px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.panel-header {
    background: #f8f9fa; padding: 12px 15px; border-bottom: 1px solid #ddd;
    display: flex; justify-content: space-between; align-items: center;
}
.panel-header h3 { margin: 0; font-size: 18px; color: #2c3e50; }
.panel-header .subtitle { font-size: 12px; color: #666; font-weight: normal; margin-left: 5px;}
.header-btns { display: flex; gap: 8px; }

.input-area { padding: 15px; background: #fff; border-bottom: 1px solid #eee; }
.input-row { display: flex; gap: 10px; margin-bottom: 5px; }
.input-area textarea {
    flex: 1; height: 60px; font-size: 15px; padding: 8px;
    border: 1px solid #ced4da; border-radius: 4px; resize: none; font-family: inherit;
}
.date-picker-wrapper { display: flex; flex-direction: column; gap: 5px; min-width: 130px; }
.date-picker-wrapper label { font-size: 12px; color: #666; }
.date-picker-wrapper input[type="date"] { padding: 6px; border: 1px solid #ced4da; border-radius: 4px; }

/* æŒ‰éˆ•æ¨£å¼ */
.btn { padding: 5px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: 0.2s; white-space: nowrap;}
.btn-sm { padding: 4px 8px; font-size: 12px; }
.btn-primary { background: #0984e3; color: white; } .btn-primary:hover { background: #0070d6; }
.btn-warning { background: #fdcb6e; color: #333; } .btn-warning:hover { background: #e1b12c; }
.btn-danger { background: #d63031; color: white; } .btn-danger:hover { background: #c02828; }
.btn-secondary { background: #b2bec3; color: white; } .btn-secondary:hover { background: #636e72; }
.btn-success { background: #00b894; color: white; } .btn-success:hover { background: #00896c; }
.btn-info { background: #17a2b8; color: white; } .btn-info:hover { background: #138496; }

/* ç®¡ç†åˆ—è¡¨è¡¨æ ¼ */
.list-view { flex: 1; overflow-y: auto; background: #fff; }
.admin-table { width: 100%; border-collapse: collapse; font-size: 14px; table-layout: fixed; }
.admin-table th {
    position: sticky; top: 0; background: #dfe6e9; color: #2d3436;
    padding: 8px 5px; text-align: left; font-weight: 600; z-index: 2; border-bottom: 2px solid #ccc;
    white-space: nowrap;
}
.admin-table td {
    padding: 8px 5px; border-bottom: 1px solid #f1f1f1; color: #333;
    vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.admin-table tr:hover { background-color: #f8f9fa; }

/* ç‹€æ…‹æ¨™ç±¤ */
.badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; display: inline-block; text-align: center; min-width: 40px;}
.badge-valid { background: #e3fcef; color: #00b894; border: 1px solid #00b894; }
.badge-expired { background: #ffecec; color: #d63031; border: 1px solid #d63031; }
.badge-perm { background: #e3f2fd; color: #0984e3; border: 1px solid #0984e3; }
.row-expired td { color: #b2bec3; } 
.row-expired .item-name { text-decoration: line-through; }

/* åº•éƒ¨åŠŸèƒ½å€ */
.footer-actions {
    max-width: 1300px; margin: 20px auto; padding: 0 20px;
    display: flex; gap: 10px; justify-content: flex-end; align-items: center; flex-wrap: wrap;
}
.action-group {
    display: flex; gap: 5px; padding: 5px 10px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9;
}

/* =========================================
   3. ç·¨è¼¯å½ˆçª— (Modal)
   ========================================= */
.modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
}
.modal-content {
    background: white; padding: 25px; border-radius: 8px; width: 450px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.modal-header { font-size: 18px; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; color: #333; font-weight: bold; font-size: 14px; }
.form-group input[type="text"], .form-group input[type="date"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }

.expiry-options { background: #f0f7ff; padding: 10px; border-radius: 6px; border: 1px solid #cce5ff; margin-top: 15px; }
.radio-group { display: flex; gap: 15px; margin-bottom: 10px; flex-wrap: wrap;}
.radio-label { display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 14px; }

.modal-footer { margin-top: 25px; display: flex; justify-content: space-between; gap: 10px; }

/* =========================================
   4. åˆ—å°èˆ‡é è¦½è¨­å®š (ä¿®å¾©ç©ºç™½é )
   ========================================= */
@media print {
    .controls-wrapper, .footer-actions, .modal-overlay { display: none !important; }
    
    /* ç¢ºä¿å®¹å™¨ä¸ä½”é¡å¤–ç©ºé–“ */
    .page-preview-wrapper { 
        display: block !important; 
        padding: 0 !important; 
        margin: 0 !important; 
    }
    
    /* æ¯ä¸€é åŸºæœ¬çš„å¼·åˆ¶åˆ†é  */
    .page { 
        page-break-after: always; 
        display: block !important; 
        margin: 0 !important; 
        box-shadow: none !important; 
        /* ç¢ºä¿å¾é ‚éƒ¨é–‹å§‹ */
        position: relative !important;
        top: 0 !important;
    }

    /* â˜…â˜…â˜… é—œéµä¿®å¾©ï¼šæœ€å¾Œä¸€é  (è¶…è–¦) ä¸è¦åˆ†é  â˜…â˜…â˜… */
    .page-wang { 
        page-break-after: auto !important; 
    }

    body { background-color: white; margin: 0; padding: 0; }
}

.page-preview-wrapper {
    display: flex; flex-direction: column; align-items: center; gap: 20px; padding-bottom: 50px;
}
.page {
    position:relative; width: 794px; height: 1123px;
    font-family:'GenRyuMin2',serif; 
    background: white; box-shadow: 0 0 15px rgba(0,0,0,0.1); margin: 0 auto;
    display: block;
}

.container{position:relative;width:680px;margin:0 auto;height:100%;}
.header-left{position:absolute;top:50px;left:0;display:flex;align-items:center;}
.header-left .logo{width:19px;margin-right:8px;}
.header-left .temple-name{font-size:16px;letter-spacing:1px;}
.list-title{position:absolute;top:30px;left:0;right:0;text-align:center;font-size:40px;letter-spacing:8px;}
.date-label{position:absolute;top:57px;right:0;font-size:12px;}

:root{ --frame-top:100px; --sub-height:120px; }
.frame{
  position:absolute; top:var(--frame-top); left:0;right:0; bottom:110px;
  border:2px solid #000; display:flex;flex-direction:column;overflow:hidden;
}
.page-wang .frame{bottom:140px;}
.page-wang .sub{flex:0 0 100px;}
.sub{ flex:0 0 var(--sub-height); padding:0 8px;font-size:22px;text-align:center; display:flex;align-items:center;justify-content:center; line-height:1.4; }
.data{flex:1;display:grid;grid-template-columns:repeat(4,1fr); grid-template-rows:repeat(15,1fr);}
.page-wang .data{grid-template-rows:repeat(14,1fr);}
.data table,.data tbody,.data tr{display:contents;}

.data td {
    border:1px solid #000; display:flex; align-items:center; justify-content:center;
    font-size:16px; font-family:'BpmfGenRyuMin','GenRyuMin2',serif;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; position: relative;
}
.data td div {
    line-height:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    display: flex; align-items: center; justify-content: center; height: 100%; width: 100%;
}
.data td:first-child{border-left:none;} .data td:last-child{border-right:none;}
.data td:nth-last-child(-n+4){border-bottom:none;}

.hejiao, .date-display {
    position: absolute; font-family: 'GenRyuMin2', serif; line-height: 1; z-index: 10; font-size: 10px;
}
.date-display { top: 2px; right: 2px; }
.hejiao { bottom: 2px; right: 2px; }

.footer-xiaozai,.footer-wang{ position:absolute;left:0px;right:0px;text-align:center; }
.footer-xiaozai{bottom:10px;}
.footer-wang {bottom:10px;}
.blessing-x{font-size:22px;line-height:1.6;}
.note-x{font-size:14px;margin-top:8px;display:inline-block;}
.blessing-w{font-size:20px;line-height:1.6;}    
.footer .three{font-size:10px;}
</style>
</head>
<body>

<div id="edit-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">ä¿®æ”¹è³‡æ–™ <span id="modal-type-title" style="font-size:14px; color:#666; font-weight:normal;"></span></div>
        <div class="form-group">
            <label>å§“å</label>
            <input type="text" id="edit-name-input">
        </div>
        <div class="form-group">
            <label>èµ·å§‹æ—¥æœŸ</label>
            <input type="date" id="edit-date-input">
        </div>
        <div class="expiry-options">
            <label style="font-weight:bold; margin-bottom:5px; display:block;">æœ‰æ•ˆæœŸè¨­å®š</label>
            <div class="radio-group" id="radio-container"></div>
            <div id="custom-date-row" style="display:none; margin-top:5px;">
                <label style="font-size:12px;">æˆªæ­¢æ—¥æœŸï¼š</label>
                <input type="date" id="edit-expiry-input">
            </div>
        </div>
        <div class="form-group" style="margin-top:15px;">
            <label style="display:flex; align-items:center; cursor:pointer;">
                <input type="checkbox" id="edit-hejiao-input" style="width:auto; margin-right:8px;"> é¡¯ç¤ºã€Œé—”å®¶ã€
            </label>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" id="btn-modal-delete">åˆªé™¤æ­¤ç­†</button>
            <div class="right-btns">
                <button class="btn btn-secondary" id="btn-modal-cancel">å–æ¶ˆ</button>
                <button class="btn btn-success" id="btn-modal-save">å„²å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>
</div>

<div class="controls-wrapper">
    <div class="top-bar">
        <div class="app-title">
            <img src="https://github.com/mt3722/TableMaker/blob/main/121203.png?raw=true" width="30" alt="">
            å›å‘åå–®ç®¡ç†ç³»çµ±
        </div>
        <div class="print-btn-group">
            <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å° / é è¦½ PDF</button>
        </div>
    </div>

    <div class="controls-container">
        <div class="panel">
            <div class="panel-header">
                <h3>æ¶ˆç½åå–® <span class="subtitle">é è¨­ 7 å¤©</span></h3>
                <div class="header-btns">
                    <button class="btn btn-warning btn-sm" id="btn-clean-xiaozai">æ¸…é™¤éæœŸ</button>
                    <button class="btn btn-danger btn-sm" id="btn-reset-xiaozai">æ¸…ç©ºæ‰€æœ‰</button>
                </div>
            </div>
            <div class="input-area">
                <div class="input-row">
                    <textarea id="input-xiaozai" placeholder="è¼¸å…¥å§“å (å¤šç­†è«‹ç”¨æ›è¡Œæˆ–é€—è™Ÿéš”é–‹)"></textarea>
                    <div class="date-picker-wrapper">
                        <label>èµ·å§‹æ—¥æœŸ</label>
                        <input type="date" id="date-picker-x">
                        <button class="btn btn-primary" id="btn-add-xiaozai" style="margin-top:auto; width:100%;">æ–°å¢</button>
                    </div>
                </div>
            </div>
            <div class="list-view">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th width="30%">å§“å</th>
                            <th width="20%">èµ·å§‹</th>
                            <th width="20%">çµæŸ</th>
                            <th width="15%">ç‹€æ…‹</th>
                            <th width="15%">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="list-xiaozai"></tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h3>è¶…è–¦åå–® <span class="subtitle">é è¨­ 49 å¤©</span></h3>
                <div class="header-btns">
                    <button class="btn btn-warning btn-sm" id="btn-clean-wangsheng">æ¸…é™¤éæœŸ</button>
                    <button class="btn btn-danger btn-sm" id="btn-reset-wangsheng">æ¸…ç©ºæ‰€æœ‰</button>
                </div>
            </div>
            <div class="input-area">
                <div class="input-row">
                    <textarea id="input-wangsheng" placeholder="è¼¸å…¥å§“å (å¤šç­†è«‹ç”¨æ›è¡Œæˆ–é€—è™Ÿéš”é–‹)"></textarea>
                    <div class="date-picker-wrapper">
                        <label>èµ·å§‹æ—¥æœŸ</label>
                        <input type="date" id="date-picker-w">
                        <button class="btn btn-primary" id="btn-add-wangsheng" style="margin-top:auto; width:100%;">æ–°å¢</button>
                    </div>
                </div>
            </div>
            <div class="list-view">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th width="30%">å§“å</th>
                            <th width="20%">èµ·å§‹</th>
                            <th width="20%">çµæŸ</th>
                            <th width="15%">ç‹€æ…‹</th>
                            <th width="15%">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="list-wangsheng"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="footer-actions">
        <div class="action-group">
            <button class="btn btn-secondary" id="btn-download-txt-x">ä¸‹è¼‰æ¶ˆç½TXT</button>
            <button class="btn btn-info" onclick="document.getElementById('import-txt-x').click()">åŒ¯å…¥æ¶ˆç½TXT</button>
            <input type="file" id="import-txt-x" accept=".txt,.csv" style="display:none">
        </div>
        <div class="action-group">
            <button class="btn btn-secondary" id="btn-download-txt-w">ä¸‹è¼‰è¶…è–¦TXT</button>
            <button class="btn btn-info" onclick="document.getElementById('import-txt-w').click()">åŒ¯å…¥è¶…è–¦TXT</button>
            <input type="file" id="import-txt-w" accept=".txt,.csv" style="display:none">
        </div>
        <div class="action-group" style="background:#e8f5e9; border-color:#c8e6c9;">
            <button class="btn btn-success" id="btn-backup">å‚™ä»½è³‡æ–™åº«(JSON)</button>
            <button class="btn btn-danger" id="btn-restore">é‚„åŸè³‡æ–™åº«(JSON)</button>
            <input type="file" id="file-restore" accept=".json" style="display:none">
        </div>
    </div>
</div>

<div class="page-preview-wrapper">
    <div class="page page-xiao">
      <div class="container">
        <div class="header-left">
          <img class="logo" src="https://github.com/mt3722/TableMaker/blob/main/121203.png?raw=true" alt="LOGO">
          <div class="temple-name">æ·¨åœŸå®—ç«¹å±±å¿µä½›æœƒ</div>
        </div>
        <div class="list-title">æ¶ˆ ç½ è€…</div>
        <div class="date-label" id="date-xiaozai"></div>
        <div class="frame">
          <div class="sub">
            å›å‘ä¸­è¯æ·¨åœŸå®—å”æœƒå››çœ¾å¼Ÿå­<br>
            ä»Šæ—¥èˆ‡æœƒå¤§çœ¾åŠçœ·å±¬ã€€æ¶ˆç½å ‚ä¸Šä¸€åˆ‡æ¶ˆç½è€…<br>
            ä»¥åŠæ¶ˆç½è€…ï¼šï¼ˆå¿µåå–®ï¼‰
          </div>
          <div class="data"><table><tbody id="tbody-xiaozai"></tbody></table></div>
        </div>
        <p class="footer footer-xiaozai">
          <span class="blessing-x">æ¥­éšœæ¶ˆé™¤ã€€ç¦æ…§å¢é•·ã€€èº«å¿ƒå®‰æ¨‚ã€€ä¸€åˆ‡å‰ç¥¥</span><br>
          <span class="note-x">( ç¿»é ç¹¼çºŒ )</span>
        </p>
      </div>
    </div>

    <div class="page page-wang">
      <div class="container">
        <div class="header-left">
          <img class="logo" src="https://github.com/mt3722/TableMaker/blob/main/121203.png?raw=true" alt="LOGO">
          <div class="temple-name">æ·¨åœŸå®—ç«¹å±±å¿µä½›æœƒ</div>
        </div>
        <div class="list-title">è¶…  è–¦  è€…</div>
        <div class="date-label" id="date-wangsheng"></div>
        <div class="frame">
          <div class="sub">
            å†å›å‘å¾€ç”Ÿå ‚ä¸Šçœ¾ç­‰å¾€ç”Ÿè€…<br>
            ä»¥åŠå¾€ç”Ÿè€…ï¼šï¼ˆå¿µåå–®ï¼‰
          </div>
          <div class="data"><table><tbody id="tbody-wangsheng"></tbody></table></div>
        </div>
        <p class="footer footer-wang">
          <span class="blessing-w">
            è’™ä½›æ¥å¼•ã€€å¾€ç”Ÿè¥¿æ–¹<br>
            é¡˜ä»¥æ­¤åŠŸå¾·ã€€å¹³ç­‰æ–½ä¸€åˆ‡ã€€åŒç™¼è©æå¿ƒã€€å¾€ç”Ÿå®‰æ¨‚åœ‹<br>
            å—ç„¡é˜¿å½Œé™€ä½› <span class="three">(ä¸‰ç¨±)</span>
          </p>
      </div>
    </div>
</div>

<script>
const STORAGE_KEY = 'temple_list_data_v2';
let db = { xiaozai: [], wangsheng: [] };
let currentEditType = null;
let currentEditId = null;

document.addEventListener('DOMContentLoaded', () => {
    const todayStr = new Date().toISOString().split('T')[0];
    document.getElementById('date-picker-x').value = todayStr;
    document.getElementById('date-picker-w').value = todayStr;
    initApp();
});

function initApp() {
    loadFromStorage();
    setupEventListeners();
    updateUI(); 
}

function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
function getTodayMidnight() { const now = new Date(); return new Date(now.getFullYear(), now.getMonth(), now.getDate()); }

function getExpiryDate(item, type) {
    if (item.isPermanent) return null;
    if (item.manualExpiryIso) return new Date(item.manualExpiryIso);

    const start = new Date(item.parsedDateIso);
    const defaultDays = (type === 'xiaozai') ? 7 : 49;
    const days = item.durationDays || defaultDays;
    const exp = new Date(start);
    exp.setDate(start.getDate() + days);
    return exp;
}

function checkExpired(item, type) {
    const expDate = getExpiryDate(item, type);
    if (expDate === null) return false;
    const today = getTodayMidnight();
    return today > expDate;
}

function parseInput(text, type, defaultDateVal) {
    const tokens = text.split(/\r?\n|,/).map(s=>s.trim()).filter(Boolean);
    const newItems = [];
    const currentYear = new Date().getFullYear();

    tokens.forEach(t => {
        let workingString = t;
        let displayDate = null;
        let parsedDateIso = null;
        let isHeJiao = false;
        let isNextYear = false;

        const dateRegex = /(\d{1,2}[\/-]\d{1,2})\s*(\.?)/;
        const match = workingString.match(dateRegex);
        if (match) {
            displayDate = match[1];
            if (match[2] === '.') isNextYear = true;
            workingString = workingString.replace(match[0], '').trim();
        }

        if (!displayDate && defaultDateVal) {
            const dObj = new Date(defaultDateVal);
            displayDate = `${dObj.getMonth()+1}/${dObj.getDate()}`;
            parsedDateIso = dObj.toISOString();
        } else if (displayDate) {
            const [mm, dd] = displayDate.split(/[\/-]/).map(Number);
            let year = currentYear;
            if (isNextYear) year++;
            const dateObj = new Date(year, mm - 1, dd);
            parsedDateIso = dateObj.toISOString();
        }

        const hejiaoRegex = /(é—”å®¶|åˆå®¶|\+)/g;
        if (hejiaoRegex.test(workingString)) {
            isHeJiao = true;
            workingString = workingString.replace(hejiaoRegex, '').trim();
        }

        if (workingString) {
            newItems.push({
                id: generateId(),
                name: workingString,
                displayDate: displayDate,
                parsedDateIso: parsedDateIso,
                isHeJiao: isHeJiao,
                durationDays: (type === 'xiaozai' ? 7 : 49),
                isPermanent: false,
                manualExpiryIso: null
            });
        }
    });
    return newItems;
}

function updateUI() {
    renderAdminList('xiaozai');
    renderAdminList('wangsheng');
    renderPrintTable('xiaozai');
    renderPrintTable('wangsheng');
    const now = new Date();
    const dateStr = `${now.getFullYear()-1911}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
    document.getElementById('date-xiaozai').textContent = dateStr;
    document.getElementById('date-wangsheng').textContent = dateStr;
}

function renderAdminList(type) {
    const tbody = document.getElementById(`list-${type}`);
    tbody.innerHTML = '';
    const list = [...db[type]].reverse();

    list.forEach(item => {
        const isExpired = checkExpired(item, type);
        const tr = document.createElement('tr');
        if (isExpired) tr.classList.add('row-expired');

        let statusBadge = '';
        let endDateStr = '--';

        if (item.isPermanent) {
            statusBadge = '<span class="badge badge-perm">æ°¸ä¹…</span>';
            endDateStr = 'âˆ';
        } else {
            const exp = getExpiryDate(item, type);
            if (exp) {
                endDateStr = `${exp.getMonth()+1}/${exp.getDate()}`;
                statusBadge = isExpired 
                    ? '<span class="badge badge-expired">éæœŸ</span>' 
                    : '<span class="badge badge-valid">æœ‰æ•ˆ</span>';
            } else {
                statusBadge = '<span class="badge badge-expired">ç„¡æ•ˆ</span>';
            }
        }

        let displayName = `<span class="item-name">${item.name}</span>` + (item.isHeJiao ? ' <small style="color:#666">(é—”å®¶)</small>' : '');
        let startDateStr = item.displayDate || '--';

        tr.innerHTML = `
            <td>${displayName}</td>
            <td>${startDateStr}</td>
            <td>${endDateStr}</td>
            <td>${statusBadge}</td>
            <td><button class="btn btn-secondary btn-sm" onclick="openEditModal('${type}', '${item.id}')">ä¿®æ”¹</button></td>
        `;
        tbody.appendChild(tr);
    });
}

function renderPrintTable(type) {
    const tbody = document.getElementById(`tbody-${type}`);
    tbody.innerHTML = '';
    const validItems = db[type].filter(item => !checkExpired(item, type));
    
    const strokeCol = new Intl.Collator('zh-Hant-u-co-stroke');
    const special = validItems.filter(x => x.name.startsWith('é‡‹') || x.name.endsWith('æ³•å¸«'));
    const rest = validItems.filter(x => !special.includes(x));
    special.sort((a, b) => strokeCol.compare(a.name, b.name));
    rest.sort((a, b) => strokeCol.compare(a.name, b.name));
    const ordered = [...special, ...rest];

    const rows = (type === 'xiaozai') ? 15 : 14;
    const totalCells = rows * 4;

    for(let r=0; r<rows; r++) {
        const tr = document.createElement('tr');
        for(let c=0; c<4; c++) {
            const td = document.createElement('td');
            const div = document.createElement('div');
            td.appendChild(div);
            tr.appendChild(td);
        }
        tbody.appendChild(tr);
    }

    const tds = [...tbody.querySelectorAll('td')];
    ordered.slice(0, totalCells).forEach((it, i) => {
        const td = tds[i];
        const div = td.querySelector('div');
        const cleanName = [...it.name].map(ch => /[\u4e00-\u9fff\u3105-\u3129a-zA-Z0-9]/.test(ch) ? ch : '').join('');
        div.innerHTML = cleanName;

        const baseSize = 24; const baseLen = 4; const len = cleanName.length;
        if (len > baseLen) {
            let newSize = Math.floor((baseSize * baseLen) / len);
            newSize = Math.max(newSize, 12);
            div.style.fontSize = `${newSize}px`;
        } else {
            div.style.fontSize = `${baseSize}px`;
        }
        
        if (!it.isPermanent) {
            const exp = getExpiryDate(it, type);
            if (exp) {
                const dateStr = `${exp.getMonth()+1}/${exp.getDate()}`;
                const s = document.createElement('span'); s.className='date-display'; s.textContent=dateStr;
                td.appendChild(s);
            }
        }
        if (type === 'xiaozai' && it.isHeJiao) {
            const s = document.createElement('span'); s.className='hejiao'; s.textContent='é—”å®¶';
            td.appendChild(s);
        }
    });
}

window.openEditModal = function(type, id) {
    const item = db[type].find(i => i.id === id);
    if (!item) return;
    currentEditType = type;
    currentEditId = id;

    document.getElementById('edit-name-input').value = item.name;
    document.getElementById('edit-hejiao-input').checked = item.isHeJiao;
    document.getElementById('edit-date-input').value = item.parsedDateIso ? item.parsedDateIso.split('T')[0] : '';

    const radioContainer = document.getElementById('radio-container');
    const defaultDays = (type === 'xiaozai') ? 7 : 49;
    
    radioContainer.innerHTML = `
        <label class="radio-label"><input type="radio" name="duration-opt" value="default" checked> ${defaultDays}å¤©</label>
        <label class="radio-label"><input type="radio" name="duration-opt" value="perm"> æ°¸ä¹…</label>
        <label class="radio-label"><input type="radio" name="duration-opt" value="custom"> è‡ªè¨‚</label>
    `;

    const radios = document.getElementsByName('duration-opt');
    const customRow = document.getElementById('custom-date-row');
    const customInput = document.getElementById('edit-expiry-input');
    customRow.style.display = 'none';

    if (item.isPermanent) {
        radios[1].checked = true;
    } else if (item.manualExpiryIso) {
        radios[2].checked = true;
        customRow.style.display = 'block';
        customInput.value = item.manualExpiryIso.split('T')[0];
    } else {
        radios[0].checked = true;
    }

    radios.forEach(r => {
        r.addEventListener('change', (e) => {
            customRow.style.display = (e.target.value === 'custom') ? 'block' : 'none';
        });
    });

    document.getElementById('modal-type-title').textContent = (type==='xiaozai'?'(æ¶ˆç½)':'(è¶…è–¦)');
    document.getElementById('edit-modal').style.display = 'flex';
};

function saveEdit() {
    if (!currentEditType || !currentEditId) return;
    const item = db[currentEditType].find(i => i.id === currentEditId);
    
    const newName = document.getElementById('edit-name-input').value.trim();
    if (!newName) { alert('å§“åä¸èƒ½ç‚ºç©º'); return; }
    item.name = newName;
    item.isHeJiao = document.getElementById('edit-hejiao-input').checked;
    
    const newStartDate = document.getElementById('edit-date-input').value;
    if (newStartDate) {
        const d = new Date(newStartDate);
        item.parsedDateIso = d.toISOString();
        item.displayDate = `${d.getMonth()+1}/${d.getDate()}`;
    }

    const mode = document.querySelector('input[name="duration-opt"]:checked').value;
    const defaultDays = (currentEditType === 'xiaozai') ? 7 : 49;

    if (mode === 'perm') {
        item.isPermanent = true;
        item.manualExpiryIso = null;
        item.durationDays = 0;
    } else if (mode === 'custom') {
        const dateVal = document.getElementById('edit-expiry-input').value;
        if (!dateVal) { alert('è«‹é¸æ“‡æˆªæ­¢æ—¥æœŸ'); return; }
        item.isPermanent = false;
        item.manualExpiryIso = new Date(dateVal).toISOString();
        item.durationDays = 0;
    } else {
        item.isPermanent = false;
        item.manualExpiryIso = null;
        item.durationDays = defaultDays;
    }

    saveToStorage();
    document.getElementById('edit-modal').style.display = 'none';
}

function deleteCurrentEdit() {
    if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ')) return;
    db[currentEditType] = db[currentEditType].filter(item => item.id !== currentEditId);
    saveToStorage();
    document.getElementById('edit-modal').style.display = 'none';
}

function handleImportTxt(e, type) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
        const text = evt.target.result;
        const defaultDate = new Date().toISOString().split('T')[0];
        const newItems = parseInput(text, type, defaultDate);
        if (newItems.length > 0) {
            db[type].push(...newItems);
            saveToStorage();
            alert(`æˆåŠŸåŒ¯å…¥ ${newItems.length} ç­†è³‡æ–™`);
        } else { alert('ç„¡æ³•è§£æè³‡æ–™'); }
        e.target.value = '';
    };
    reader.readAsText(file);
}

function downloadTxt(type) {
    const validItems = db[type].filter(item => !checkExpired(item, type));
    const lines = validItems.map(item => {
        let parts = [];
        if (item.displayDate) parts.push(item.displayDate);
        parts.push(item.name);
        if (item.isHeJiao && type === 'xiaozai') parts.push('é—”å®¶');
        return parts.join('');
    });
    downloadFile(`${type==='xiaozai'?'æ¶ˆç½':'è¶…è–¦'}_${getTimestamp()}.txt`, lines.join(','));
}

function loadFromStorage() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) { try { db = JSON.parse(raw); } catch (e) { console.error(e); } }
}
function saveToStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    updateUI();
}
function backupJson() { downloadFile(`Backup_${getTimestamp()}.json`, JSON.stringify(db, null, 2)); }
function restoreJson(e) {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
        try {
            const imported = JSON.parse(evt.target.result);
            if(confirm('ç¢ºå®šé‚„åŸï¼Ÿç¾æœ‰è³‡æ–™å°‡è¢«è¦†è“‹')) { db = imported; saveToStorage(); }
        } catch(err) { alert('JSON æ ¼å¼éŒ¯èª¤'); }
        e.target.value = '';
    };
    reader.readAsText(file);
}
function downloadFile(name, content) {
    const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function getTimestamp() { return new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 12); }

function setupEventListeners() {
    ['xiaozai', 'wangsheng'].forEach(type => {
        document.getElementById(`btn-add-${type}`).onclick = () => {
            const input = document.getElementById(`input-${type}`);
            const datePicker = document.getElementById(type === 'xiaozai' ? 'date-picker-x' : 'date-picker-w');
            const items = parseInput(input.value, type, datePicker.value);
            if (items.length > 0) { db[type].push(...items); input.value = ''; saveToStorage(); } 
            else { alert('è«‹è¼¸å…¥å§“å'); }
        };
        document.getElementById(`btn-clean-${type}`).onclick = () => {
            if(confirm(`ç¢ºå®šæ¸…é™¤éæœŸåå–®ï¼Ÿ`)) {
                db[type] = db[type].filter(item => !checkExpired(item, type));
                saveToStorage();
            }
        };
        // â˜…â˜…â˜… æ¸…ç©ºæ‰€æœ‰æŒ‰éˆ•çš„ç›£è½ â˜…â˜…â˜…
        document.getElementById(`btn-reset-${type}`).onclick = () => {
            if(confirm(`ã€åš´é‡è­¦å‘Šã€‘\næ‚¨ç¢ºå®šè¦ã€Œæ¸…ç©ºã€æ‰€æœ‰${type==='xiaozai'?'æ¶ˆç½':'è¶…è–¦'}è³‡æ–™å—ï¼Ÿ\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`)) {
                if(confirm('è«‹å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦å…¨éƒ¨åˆªé™¤å—ï¼Ÿ')) {
                    db[type] = [];
                    saveToStorage();
                    alert('å·²æ¸…ç©ºæ‰€æœ‰è³‡æ–™ã€‚');
                }
            }
        };
        document.getElementById(`btn-download-txt-${type[0]}`).onclick = () => downloadTxt(type);
    });

    document.getElementById('import-txt-x').onchange = (e) => handleImportTxt(e, 'xiaozai');
    document.getElementById('import-txt-w').onchange = (e) => handleImportTxt(e, 'wangsheng');
    document.getElementById('btn-modal-cancel').onclick = () => document.getElementById('edit-modal').style.display = 'none';
    document.getElementById('btn-modal-save').onclick = saveEdit;
    document.getElementById('btn-modal-delete').onclick = deleteCurrentEdit;
    document.getElementById('edit-modal').onclick = (e) => { if(e.target.id === 'edit-modal') document.getElementById('edit-modal').style.display = 'none'; };
    document.getElementById('btn-backup').onclick = backupJson;
    document.getElementById('btn-restore').onclick = () => document.getElementById('file-restore').click();
    document.getElementById('file-restore').onchange = restoreJson;
}
</script>
</body>
</html>
